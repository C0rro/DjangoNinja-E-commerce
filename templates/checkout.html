{% extends "base.html" %}
{% block title %}Checkout - Il tuo Ecommerce{% endblock %}

{% block content %}

<form id="csrf-form" style="display: none;">
    {% csrf_token %}
</form>

<div class="container mx-auto p-4 sm:p-8">

    <div class="bg-white shadow-xl rounded-lg p-6 mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-center">
            <p id="auth-status" class="text-xl font-bold mb-4 sm:mb-0">Verifica stato...</p>

            <div id="auth-buttons" class="space-x-4 flex">
                <a href="{% url 'login' %}" class="btn btn-primary">Accedi</a>
            </div>
        </div>
    </div>

    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">Dettagli di Spedizione</h1>

    <div class="bg-white shadow-xl rounded-lg p-6">
        <form id="checkout-form">

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">Nome Completo</span></label>
                <input id="full_name" type="text" placeholder="Mario Rossi" class="input input-bordered w-full" required />
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">Email</span></label>
                <input id="email" type="email" placeholder="nome@esempio.com" class="input input-bordered w-full" required />
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">Indirizzo (Via e Numero Civico)</span></label>
                <input id="address" type="text" placeholder="Via Roma, 10" class="input input-bordered w-full" required />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

                <div class="form-control">
                    <label class="label"><span class="label-text">Citt√†</span></label>
                    <input id="city" type="text" placeholder="Milano" class="input input-bordered w-full" required />
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">CAP</span></label>
                    <input id="postal_code" type="text" placeholder="20100" class="input input-bordered w-full" required />
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Provincia (Sigla)</span></label>
                    <input id="province" type="text" placeholder="MI" class="input input-bordered w-full" required />
                </div>
            </div>

            <button type="button" id="submit-button" onclick="handleCheckout();" class="btn btn-primary text-white w-full">Conferma Ordine e Procedi al Pagamento</button>

        </form>
    </div>

</div>

<script>
    const statusElement = document.getElementById('auth-status');
    const authButtons = document.getElementById('auth-buttons');
    const checkoutForm = document.getElementById('checkout-form');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function prefillForm(data) {
        document.getElementById('full_name').value = data.first_name+" "+data.last_name|| '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('address').value = data.profile.address || '';
        document.getElementById('city').value = data.profile.city || '';
        document.getElementById('province').value = data.profile.province || '';
        document.getElementById('postal_code').value = data.profile.postal_code || '';
        document.getElementById('province').value = data.profile.province || '';
    }

    /**
     * Controlla lo stato di autenticazione usando l'endpoint protetto.
     */
    async function logUser() {
        try {
            // La richiesta invia automaticamente il cookie di sessione (se presente)
            const response = await fetch("/app/protected");

            if (response.ok) {
                const data = await response.json();
                statusElement.textContent = `‚úÖ Sei loggato come: ${data.email}.`;
                statusElement.classList.add('text-success');
                authButtons.style.display = 'none';

                prefillForm(data);

            } else if (response.status === 401 || response.status === 403) {
                // Stato 401/403: Sessione non valida o non autenticata
                statusElement.textContent = `‚ùå Non sei loggato. Accedi per continuare.`;
                statusElement.classList.add('text-error');

            } else {
                // Altri errori del server (500, ecc.)
                statusElement.textContent = `‚ö†Ô∏è Errore server: ${response.status} - Impossibile verificare l'autenticazione.`;
                statusElement.classList.add('text-warning');
            }

        } catch (error) {
            console.error("Errore di rete durante la verifica:", error);
            statusElement.textContent = `üõë Errore di connessione. Riprova pi√π tardi.`;
            statusElement.classList.add('text-warning');
        }
    }

    const cart = JSON.parse('{{ cart|safe|escapejs }}');
    /**
     * Gestisce l'invio del form al tuo endpoint API di checkout.
     */
    async function handleCheckout() {
        const checkoutData = {
            shipping_name: document.getElementById('full_name').value,
            email: document.getElementById('email').value,
            shipping_address: document.getElementById('address').value,
            shipping_city: document.getElementById('city').value,
            shipping_province: document.getElementById('province').value,
            shipping_postal_code: document.getElementById('postal_code').value,
            shipping_phone:  null,

            total_price: 49.99,
            products: cart,
        };

        const submitButton = document.getElementById('submit-button');
        submitButton.classList.add('loading');
        submitButton.disabled = true;

        try {
            const response = await fetch('/app/shop/carrello/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(checkoutData)
            });

            if (response.ok) {
                const result = await response.json();
                alert(`Ordine Inviato! ID Ordine: ${result.id}`);

            } else {
                const errorData = await response.json();
                console.error("Errore Dettagliato:", errorData);
                alert(`Errore nell'invio dell'ordine: ${errorData.detail || 'Si √® verificato un errore sconosciuto.'}`);
            }

        } catch (error) {
            console.error("Errore di rete durante il checkout:", error);
            alert("Errore di connessione. Impossibile completare l'ordine.");
        } finally {
            //submitButton.classList.remove('loading');
            //submitButton.disabled = false;
            window.location.href = `./`;
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', logUser);
</script>
{% endblock %}